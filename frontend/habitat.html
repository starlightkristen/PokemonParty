<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Habitat</title>
  <style>
    body{font-family:sans-serif;padding:24px;background:#fff8dc}
    #pname{font-size:28px;font-weight:bold}
    .crystal{display:inline-block;width:18px;height:18px;margin:4px;border-radius:4px;background:#ddd;transition:background .2s}
    .crystal.active{background:#ffb6c1}
  </style>
</head>
<body>
  <h1>Habitat</h1>
  <div id="pinfo">
    <div id="pname">UNKNOWN</div>
    <div id="pdesc">Animal info will appear here.</div>
  </div>
  <div id="crystals" style="margin-top:12px">
    <span class="crystal" id="c1" data-test-id="crystal-1"></span>
    <span class="crystal" id="c2" data-test-id="crystal-2"></span>
    <span class="crystal" id="c3" data-test-id="crystal-3"></span>
  </div>

  <script>
    async function fetchCatalog() {
      try {
        const r = await fetch('/api/animals/catalog');
        if (!r.ok) return null;
        return await r.json();
      } catch (e) { return null; }
    }

    async function getCurrent() {
      try {
        const r = await fetch('/api/animals/current');
        if (!r.ok) return null;
        return await r.json();
      } catch (e) { return null; }
    }

    function renderAnimalId(id, catalog) {
      const nameEl = document.getElementById('pname');
      if (!catalog || !catalog.animals) { nameEl.textContent = (id||'UNKNOWN').toUpperCase(); return; }
      const found = catalog.animals.find(a => a.id === id);
      nameEl.textContent = (found && found.name) ? found.name.toUpperCase() : (id||'UNKNOWN').toUpperCase();
    }

    // update crystals robustly: read progress from /api/scene/state and apply .active
    async function updateCrystals() {
      try {
        const s = await fetch('/api/scene/state');
        if (!s.ok) return;
        const js = await s.json();
        const prog = (js && js.data && js.data.progress) ? Number(js.data.progress) : 0;
        const idx = Math.min(2, Math.floor(prog / 34));
        // reset
        for (let i=1;i<=3;i++) document.getElementById('c'+i).classList.remove('active');
        if (idx >= 0) document.getElementById('c'+(idx+1)).classList.add('active');
      } catch(e) { /* ignore */ }
    }

    (async () => {
      const initial = new URLSearchParams(window.location.search).get('animal');
      const catalog = await fetchCatalog();
      if (initial) {
        renderAnimalId(initial, catalog);
      } else {
        const cur = await getCurrent();
        const curId = cur && cur.current ? cur.current : (catalog && catalog.animals && catalog.animals[0] && catalog.animals[0].id);
        renderAnimalId(curId, catalog);
      }
      // Poll for changes
      setInterval(async () => {
        const catalog = await fetchCatalog();
        const cur = await getCurrent();
        const id = (cur && cur.current) ? cur.current : null;
        renderAnimalId(id, catalog);
        await updateCrystals();
      }, 700);
    })();
  </script>
</body>
</html>