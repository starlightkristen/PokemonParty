<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pokémon Academy — Welcome</title>
  <style>
    body{font-family:sans-serif;background:#87CEEB;margin:0;padding:40px}
    .title{font-size:36px;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,0.15)}
    #statusArea{margin-top:16px}
    #statusDot{display:inline-block;width:14px;height:14px;border-radius:50%;background:#f00;margin-right:8px;vertical-align:middle}
    button.navigate{margin-top:20px;padding:8px 12px;border-radius:6px}
  </style>
</head>
<body>
  <h1 class="title">POKéMON ACADEMY</h1>
  <div id="statusArea">
    <span id="statusDot" data-test-id="welcome-status-dot" aria-hidden="true"></span>
    <span id="statusMsg" data-test-id="welcome-status-msg">PREPARING MISSION PARAMETERS...</span>
  </div>

  <div style="margin-top:24px">
    <button class="navigate" id="gotoCheckin" data-test-id="goto-checkin">Go to Check-In (Ctrl+Enter)</button>
  </div>

  <script>
    // Robust fetch with timeout helper
    async function fetchWithTimeout(url, opts = {}, timeout = 2000) {
      return Promise.race([
        fetch(url, opts),
        new Promise((_, reject) => setTimeout(() => reject(new Error('fetch-timeout')), timeout))
      ]);
    }

    // deterministic navigation: wait for /api/scene/goto to confirm, then navigate after slightly longer settle time
    async function gotoCheckin() {
      try {
        const res = await fetchWithTimeout('/api/scene/goto', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ to: 'CHECKIN' })
        }, 2500);
        if (res && res.ok) {
          // increased delay to 350ms to allow both server & client state to settle (Playwright timing)
          await new Promise(r => setTimeout(r, 350));
          // use assign to ensure navigation
          location.assign('/checkin.html');
        } else {
          console.error('scene goto failed', res && res.status);
          // fallback: try a short delay then navigate to keep tests moving
          setTimeout(() => location.assign('/checkin.html'), 600);
        }
      } catch (e) {
        console.warn('gotoCheckin fetch failed or timed out:', e);
        // fallback navigation (allows test to proceed and diagnose server delay)
        setTimeout(() => location.assign('/checkin.html'), 600);
      }
    }

    document.getElementById('gotoCheckin').addEventListener('click', gotoCheckin);
    document.addEventListener('keydown', e => { if (e.ctrlKey && e.key === 'Enter') gotoCheckin(); });

    (async () => {
      try {
        const r = await fetchWithTimeout('/api/health', {}, 1500);
        if (r && r.ok) {
          document.getElementById('statusDot').style.background = '#0c0';
          document.getElementById('statusMsg').textContent = 'READY';
        } else {
          document.getElementById('statusDot').style.background = '#f00';
          document.getElementById('statusMsg').textContent = 'NOT READY';
        }
      } catch(e) {
        document.getElementById('statusDot').style.background = '#f00';
        document.getElementById('statusMsg').textContent = 'OFFLINE';
      }
    })();
  </script>
</body>
</html>